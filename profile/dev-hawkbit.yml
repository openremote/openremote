# OpenRemote v3
#
# Profile that runs the stack by default on https://localhost using a self-signed SSL certificate,
# but optionally on https://$HOST with an auto generated SSL certificate from Letsencrypt.
#
# It is possible to specify OR_SETUP_TYPE=demo to pre-populate the system with a set of demo assets, rules, etc. (as
# is shown at https://demo.openremote.io)
# with username 'admin' and password 'secret'. There is no map data available in the vanilla
# system so the map tile server will not function. Persistent data is stored in a docker
# volume called postgresql-data between restarts, simply delete this volume to reset the
# system to an empty state.
#
# Please see profile/deploy.yml for configuration details for each service.
#
volumes:
  proxy-data:
  manager-data:
  postgresql-data:
  deployment-data:
  # hawkbit volumes
  hawkbit-data:
  hawkbit-artifact-data:

services:
  proxy:
    image: openremote/proxy:${PROXY_VERSION:-latest}
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "8883:8883"
      - "127.0.0.1:8404:8404" # Localhost metrics access
    volumes:
      - proxy-data:/deployment
      - ../deployment/proxy/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
    environment:
      LE_EMAIL: ${OR_EMAIL_FROM:-}
      DOMAINNAME: ${OR_HOSTNAME:-localhost}
      DOMAINNAMES: ${OR_ADDITIONAL_HOSTNAMES:-}
      # configure hawkbit (optional) proxy backends
      HAWKBIT_HOST: hawkbit
      HAWKBIT_PORT: 8080
      HAWKBIT_UI_HOST: hawkbit-ui
      HAWKBIT_UI_PORT: 8088
      HAPROXY_CONFIG: /etc/haproxy/haproxy.cfg

  postgresql:
    restart: always
    image: openremote/postgresql:${POSTGRESQL_VERSION:-latest}
    shm_size: 128mb
    volumes:
      - postgresql-data:/var/lib/postgresql/data
      - manager-data:/storage

  keycloak:
    restart: always
    image: openremote/keycloak:${KEYCLOAK_VERSION:-latest}
    depends_on:
      postgresql:
        condition: service_healthy
    volumes:
      - ../deployment:/deployment
    environment:
      KC_HOSTNAME: ${OR_HOSTNAME:-localhost}
      KC_HOSTNAME_PORT: ${OR_SSL_PORT:--1}
      KC_LOG_CONSOLE_FORMAT: '%-5p [%c] (%t) %s%e%n'

  manager:
    restart: always
    image: openremote/manager:${MANAGER_VERSION:-latest}
    depends_on:
      keycloak:
        condition: service_healthy
    ports:
      - "127.0.0.1:8405:8405"
    environment:
      OR_SETUP_TYPE: ${OR_SETUP_TYPE:-demo}
      OR_SSL_PORT: ${OR_SSL_PORT:--1}
      OR_HOSTNAME: ${OR_HOSTNAME:-localhost}
      OR_ADDITIONAL_HOSTNAMES:
    volumes:
      - manager-data:/storage
      - deployment-data:/deployment

  hawkbitdb:
    image: openremote/postgresql:${POSTGRESQL_VERSION:-latest}
    restart: always
    environment:
      POSTGRES_DB: 'hawkbit'
      POSTGRES_USER: ${HAWKBIT_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${HAWKBIT_DB_PASSWORD:-postgres}
    healthcheck:
      retries: 100
    volumes:
      - hawkbit-data:/var/lib/postgresql/data

  hawkbit:
    image: hawkbit/hawkbit-update-server:0.9.0
    restart: always
    depends_on:
      keycloak:
        condition: service_healthy
      hawkbitdb:
        condition: service_healthy
    healthcheck:
      interval: 3s
      timeout: 3s
      start_period: 3s
      retries: 100
      test: ["CMD", "curl", "--fail", "--silent", "http://localhost:8080/hawkbit"]
    volumes:
      - hawkbit-artifact-data:/opt/hawkbit/artifactrepo
    environment:
      - LOGGING_LEVEL_ROOT=INFO
      # databasource
      - SPRING_DATASOURCE_URL=jdbc:postgresql://hawkbitdb:5432/hawkbit
      - SPRING_DATASOURCE_USERNAME=${HAWKBIT_DB_USER:-postgres}
      - SPRING_DATASOURCE_PASSWORD=${HAWKBIT_DB_PASSWORD:-postgres}
      - spring.jpa.database=POSTGRESQL
      - spring.datasource.driverClassName=org.postgresql.Driver
      - hawkbit.dmf.rabbitmq.enabled=false
      # artifact downloads
      - hawkbit.artifact.url.protocols.download-http.port=8080
      - hawkbit.artifact.url.protocols.download-http.protocol=http
      - 'hawkbit.artifact.url.protocols.download-http.ref={protocol}://{hostnameRequest}:{port}$${server.servlet.context-path}/{tenant}/controller/v1/{controllerId}/softwaremodules/{softwareModuleId}/artifacts/{artifactFileName}'
      - hawkbit.server.ddi.security.authentication.targettoken.enabled=true
      - server.use-forward-headers=true
      - server.forward-headers-strategy=NATIVE
      - server.servlet.context-path=/hawkbit
      # OIDC/IAM config (disabled for local dev)
      #- spring.security.oauth2.client.registration.oidc.client-id=hawkbit
      #- spring.security.oauth2.client.registration.oidc.client-secret=${HAWKBIT_CLIENT_SECRET:-secret}
      #- spring.security.oauth2.client.registration.oidc.authorization-grant-type=authorization_code
      #- spring.security.oauth2.client.registration.oidc.scope=openid
      #- spring.security.oauth2.client.provider.oidc.issuer-uri=http://keycloak:8080/auth/realms/master
      #- spring.security.oauth2.client.provider.oidc.user-name-attribute=preferred_username
    ports:
      - "8083:8080"

 
  # Note, does not do OIDC yet, it is supported but needs to be figured out still.
  hawkbit-ui:
    image: "hawkbit/hawkbit-simple-ui:latest"
    environment:
      - "SPRING_APPLICATION_JSON={\"hawkbit.server.mgmtUrl\":\"http://hawkbit:8080/hawkbit\",\"server.servlet.context-path\":\"/hawkbit/ui\",\"server.use-forward-headers\":true,\"server.forward-headers-strategy\":\"NATIVE\"}"
    restart: always
    labels:
      NAME: "hawkbit-ui"
